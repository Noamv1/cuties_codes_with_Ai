<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מחולל הבדיחות</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f9f9;
            direction: rtl;
            text-align: right;
            margin: 0;
            padding: 0;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* מצב סטנדאפ */
        body.standup-mode {
            background-color: #000;
            color: #fff;
        }

        body.standup-mode .container {
            max-width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        body.standup-mode .header,
        body.standup-mode .category-filters,
        body.standup-mode .admin-section,
        body.standup-mode .footer {
            display: none;
        }

        body.standup-mode .joke-container {
            background-color: #000;
            box-shadow: none;
        }

        body.standup-mode .joke {
            font-size: 42px;
            margin-bottom: 30px;
            color: #fff;
        }

        body.standup-mode .punchline {
            font-size: 36px;
            color: #ffcc00;
        }

        body.standup-mode .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .joke, .punchline.show {
            animation: fadeIn 0.5s ease forwards;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .joke-container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            text-align: center;
            margin-bottom: 20px;
            transition: background-color 0.3s;
        }
        
        .joke {
            font-size: 24px;
            margin-bottom: 20px;
        }
        
        .punchline {
            font-size: 20px;
            font-weight: bold;
            color: #0077cc;
            margin-bottom: 20px;
            opacity: 0;
            transition: opacity 0.5s;
        }
        
        .punchline.show {
            opacity: 1;
        }
        
        .controls {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        button {
            background-color: #0077cc;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #005fa3;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .category-filters {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .category-btn {
            background-color: #eee;
            color: #333;
            border: 1px solid #ddd;
        }
        
        .category-btn.active {
            background-color: #0077cc;
            color: white;
        }
        
        .joke-info {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .joke-rating {
            margin-top: 15px;
            font-size: 16px;
        }

        .rating-star {
            cursor: pointer;
            color: #ccc;
            font-size: 24px;
            transition: color 0.2s;
        }

        .rating-star.active {
            color: gold;
        }

        .rating-star:hover {
            transform: scale(1.2);
        }

        body.dark-mode .rating-star {
            color: #444;
        }

        body.dark-mode .rating-star.active {
            color: gold;
        }
        
        /* סגנונות לאזור הניהול */
        .admin-section {
            margin-top: 40px;
            background-color: #f8f8f8;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #ddd;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .form-input, .form-select {
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #ccc;
            width: 100%;
            max-width: 400px;
            transition: border-color 0.3s, background-color 0.3s, color 0.3s;
        }
        
        .joke-form, .joke-management, .additional-features {
            margin-bottom: 20px;
        }
        
        .jokes-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .joke-item {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        
        .joke-item-controls {
            margin-top: 5px;
        }
        
        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-bottom: 15px;
        }

        .bs-d {
            font-weight: bold;
            font-size: 16px;
        }

        .created-by {
            font-size: 14px;
            color: #666;
            transition: color 0.3s;
        }

        body.dark-mode .created-by {
            color: #aaa;
        }
        
        /* סגנונות לחלון שיתוף */
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .share-modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            transition: background-color 0.3s;
        }
        
        body.dark-mode .share-modal-content {
            background-color: #333;
            color: #eee;
        }
        
        .close-modal {
            float: right;
            font-size: 24px;
            cursor: pointer;
        }
        
        /* מצב לילה */
        body.dark-mode {
            background-color: #222;
            color: #eee;
        }
        
        body.dark-mode .joke-container,
        body.dark-mode .admin-section {
            background-color: #333;
            color: #eee;
            border-color: #555;
        }
        
        body.dark-mode .joke-item {
            background-color: #444;
            border-color: #555;
        }
        
        body.dark-mode button {
            background-color: #555;
            color: #eee;
        }
        
        body.dark-mode button:hover {
            background-color: #666;
        }
        
        body.dark-mode button:disabled {
            background-color: #444;
            color: #999;
        }
        
        body.dark-mode .category-btn {
            background-color: #444;
            color: #eee;
            border-color: #555;
        }
        
        body.dark-mode .category-btn.active {
            background-color: #0077cc;
        }
        
        body.dark-mode .punchline {
            color: #66b0ff;
        }
        
        body.dark-mode .form-input,
        body.dark-mode .form-select {
            background-color: #444;
            color: #eee;
            border-color: #555;
        }
        
        body.dark-mode .joke-info {
            color: #aaa;
        }
        
        /* רספונסיביות */
        @media (max-width: 600px) {
            .joke {
                font-size: 20px;
            }
            
            .punchline {
                font-size: 18px;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .controls button {
                width: 100%;
                margin-bottom: 5px;
            }
            
            body.standup-mode .joke {
                font-size: 32px;
            }
            
            body.standup-mode .punchline {
                font-size: 28px;
            }
        }
        
        /* הוספת סגנונות עבור סרגל התקדמות */
        .progress-container {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 5px;
            height: 10px;
            margin-top: 10px;
            overflow: hidden;
            display: none;
        }

        .progress-bar {
            height: 10px;
            background-color: #0077cc;
            width: 0%;
            transition: width 0.3s ease;
        }

        body.dark-mode .progress-container {
            background-color: #444;
        }
        
        /* סגנונות לתפריט ההגדרות */
        .settings-dropdown {
            position: relative;
            display: inline-block;
        }

        .settings-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 4px;
            left: 0;
        }

        .settings-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            text-align: right;
        }

        .settings-content a:hover {
            background-color: #f1f1f1;
        }

        body.dark-mode .settings-content {
            background-color: #444;
        }

        body.dark-mode .settings-content a {
            color: #eee;
        }

        body.dark-mode .settings-content a:hover {
            background-color: #555;
        }
        
        /* סגנונות לתפריט הגדרות */
        .settings-panel {
            display: none;
            margin-top: 20px;
            background-color: #f8f8f8;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #ddd;
        }

        body.dark-mode .settings-panel {
            background-color: #333;
            border-color: #555;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #0077cc;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        /* סגנונות לפוטר */
        .footer {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            font-size: 14px;
            color: #777;
            border-top: 1px solid #eee;
            transition: color 0.3s, border-color 0.3s;
        }

        body.dark-mode .footer {
            color: #aaa;
            border-color: #444;
        }
        
        /* סגנונות לאיקונים */
        .icon-button {
            background: none;
            border: none;
            color: #0077cc;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s;
            padding: 5px;
        }

        .icon-button:hover {
            color: #005fa3;
        }

        body.dark-mode .icon-button {
            color: #66b0ff;
        }

        body.dark-mode .icon-button:hover {
            color: #99ccff;
        }
        
        /* סגנונות להיסטוריית בדיחות */
        .joke-history {
            margin-top: 20px;
            display: none;
        }
        
        .history-item {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #eee;
            transition: background-color 0.3s;
        }
        
        .history-item:hover {
            background-color: #f5f5f5;
        }
        
        body.dark-mode .history-item {
            border-color: #444;
        }
        
        body.dark-mode .history-item:hover {
            background-color: #3a3a3a;
        }
        
        .favorites-container {
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="bs-d">בס"ד</div>
            <h1>מחולל הבדיחות</h1>
            <div class="header-info">
                <div class="created-by">נוצר על ידי Noam_v</div>
                <div class="settings-dropdown">
                    <button class="icon-button" id="settings-btn">⚙️</button>
                    <div class="settings-content" id="settings-dropdown">
                        <a href="#" id="dark-mode-toggle">מצב לילה</a>
                        <a href="#" id="standup-mode-toggle">מצב סטנדאפ</a>
                        <a href="#" id="show-settings-panel">הגדרות נוספות</a>
                        <a href="#" id="show-favorites">מועדפים</a>
                        <a href="#" id="show-history">היסטוריה</a>
                    </div>
                </div>
            </div>
            <p>לחץ על הכפתור כדי לקבל בדיחה אקראית או בחר קטגוריה ספציפית</p>
        </div>
        
        <div class="category-filters">
            <button class="category-btn active" data-category="all">הכל (<span id="joke-count">0</span>)</button>
            <button class="category-btn" data-category="short">קצרות</button>
            <button class="category-btn" data-category="programmer">מתכנתים</button>
            <button class="category-btn" data-category="dad">אבא</button>
            <button class="category-btn" data-category="long">ארוכות</button>
            <button class="category-btn" data-category="children">ילדים</button>
            <button class="category-btn" data-category="animals">חיות</button>
            <button class="category-btn" data-category="workplace">עבודה</button>
            <button class="category-btn" data-category="puns">משחקי מילים</button>
            <button class="category-btn" data-category="custom">מותאמות אישית</button>
        </div>
        
        <div class="joke-container">
            <div class="joke">לחץ על "בדיחה חדשה" כדי להתחיל!</div>
            <div class="punchline"></div>
            <div class="controls">
                <button id="new-joke-btn">בדיחה חדשה</button>
                <button id="show-punchline-btn" disabled>הצג פואנטה</button>
                <button id="translate-joke-btn" disabled>תרגם לאנגלית</button>
                <button id="download-joke-btn" disabled>שמור כתמונה</button>
                <button id="favorite-joke-btn" disabled>❤️ מועדף</button>
            </div>
            <div class="joke-info">
                <span>קטגוריה: <span id="current-category">-</span></span>
                <span id="joke-counter">0/0</span>
            </div>
            <div class="joke-rating">
                <span>דרג את הבדיחה: </span>
                <span class="rating-star" data-rating="1">★</span>
                <span class="rating-star" data-rating="2">★</span>
                <span class="rating-star" data-rating="3">★</span>
                <span class="rating-star" data-rating="4">★</span>
                <span class="rating-star" data-rating="5">★</span>
                <span id="avg-rating"></span>
            </div>
            <div class="progress-container">
                <div class="progress-bar"></div>
            </div>
        </div>
        
        <div class="joke-history">
            <h3>היסטוריית בדיחות</h3>
            <div id="history-list"></div>
        </div>
        
        <div class="favorites-container">
            <h3>בדיחות מועדפות</h3>
            <div id="favorites-list"></div>
        </div>
        
        <div class="settings-panel" id="settings-panel">
            <h3>הגדרות</h3>
            <div class="setting-item">
                <span>מצב לילה</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="dark-mode-switch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span>הצגת פואנטה אוטומטית</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="auto-punchline-switch">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span>זמן המתנה לפואנטה (שניות)</span>
                <input type="range" min="1" max="10" value="3" id="punchline-delay">
                <span id="delay-value">3</span>
            </div>
            <div class="setting-item">
                <span>שמירת היסטוריית בדיחות</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="save-history-switch" checked>
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <span>גודל גופן בדיחות</span>
                <select id="font-size-select">
                    <option value="small">קטן</option>
                    <option value="medium" selected>בינוני</option>
                    <option value="large">גדול</option>
                </select>
            </div>
            <button id="save-settings">שמור הגדרות</button>
            <button id="reset-settings">איפוס הגדרות</button>
        </div>

        <div class="admin-section">
            <h2>ניהול בדיחות</h2>
            <div class="joke-form">
                <h3>הוספת בדיחה חדשה</h3>
                <input type="text" id="new-joke-setup" placeholder="הכנס את הבדיחה" class="form-input">
                <input type="text" id="new-joke-punchline" placeholder="הכנס את הפואנטה" class="form-input">
                <select id="new-joke-category" class="form-select">
                    <option value="short">קצרה</option>
                    <option value="programmer">מתכנתים</option>
                    <option value="dad">אבא</option>
                    <option value="long">ארוכה</option>
                    <option value="children">ילדים</option>
                    <option value="animals">חיות</option>
                    <option value="workplace">עבודה</option>
                    <option value="puns">משחקי מילים</option>
                    <option value="custom">מותאמת אישית</option>
                </select>
                <button onclick="addNewJoke()">הוסף בדיחה</button>
            </div>
            
            <div class="joke-management">
                <h3>ניהול בדיחות קיימות</h3>
                <button onclick="toggleJokeManagement()">הצג/הסתר רשימת בדיחות</button>
                <div id="jokes-list-container" style="display: none;">
                    <input type="text" id="joke-search" placeholder="חיפוש בדיחות..." class="form-input" onkeyup="searchJokes()">
                    <div id="jokes-list" class="jokes-list"></div>
                </div>
            </div>
            
            <div class="additional-features">
                <h3>תכונות נוספות</h3>
                <button onclick="exportJokes()">ייצוא בדיחות (JSON)</button>
                <input type="file" id="import-jokes-file" accept=".json" style="display: none;">
                <button onclick="document.getElementById('import-jokes-file').click()">ייבוא בדיחות</button>
                <button onclick="exportJokesCSV()">ייצוא בדיחות (CSV)</button>
                <button onclick="shareJoke()">שתף בדיחה נוכחית</button>
                <button onclick="deleteAllJokes()">מחק את כל הבדיחות</button>
            </div>
        </div>
        
        <div class="footer">
            <p>מחולל הבדיחות, גרסה 1.2 | לתגובות והערות: <a href="mailto:plans.noam@gmail.com">plans.noam@gmail.com</a></p>
        </div>
    </div>
    
    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <span class="close-modal" onclick="closeShareModal()">&times;</span>
            <h3>שתף בדיחה</h3>
            <div style="text-align: center; margin-bottom: 10px;">
                <img id="share-joke-icon" style="width: 100px; height: 100px; display: none; margin: 0 auto;" alt="אייקון בדיחה">
            </div>
            <p id="share-joke-text"></p>
            <textarea id="share-joke-full" rows="4" class="form-input" readonly></textarea>
            <div style="margin-top: 10px;">
                <button onclick="copyToClipboard()">העתק ללוח</button>
                <button onclick="shareViaWhatsApp()">שתף בווטסאפ</button>
                <button onclick="closeShareModal()">סגור</button>
            </div>
        </div>
    </div>
    
    <canvas id="joke-canvas" style="display: none;"></canvas>

    <script>
        // מאגר בדיחות ראשוני
        let jokes = [
            {
                setup: "למה מתכנת מעדיף את החורף?",
                punchline: "כי אז אין לו באגים!",
                category: "programmer"
            },
            {
                setup: "איך קוראים לאבא שחזר מהעבודה?",
                punchline: "אבא-דייט!",
                category: "dad"
            },
            {
                setup: "מה אמר המספר 0 למספר 8?",
                punchline: "איזו חגורה יפה יש לך!",
                category: "short"
            },
            {
                setup: "אתה יודע למה ג'אווה סקריפט כל כך עצוב?",
                punchline: "כי הוא תמיד לבד... בצד של הלקוח.",
                category: "programmer"
            },
            {
                setup: "מהו פינגווין?",
                punchline: "גולש מקוטב!",
                category: "animals"
            },
            {
                setup: "איך קוראים לדג שלובש חליפה?",
                punchline: "סלמון אופישל!",
                category: "puns"
            },
            {
                setup: "לפני שהייתי מורה, עבדתי במפעל לייצור שעונים.",
                punchline: "בהתחלה היה לי קשה, אבל אחרי זמן מה התרגלתי.",
                category: "workplace"
            },
            {
                setup: "מנהל החברה שאל אותי אם אני טוב בבניית גיליונות אקסל.",
                punchline: "אמרתי לו שאני נהדר בזה, והוא ענה 'אקסלנט'.",
                category: "workplace"
            },
            {
                setup: "שתי ילדות קטנות הולכות ברחוב. אחת שואלת את השנייה: 'איך קוראים לך?' והשנייה עונה: 'לא יודעת, אני עוד לא יודעת לקרוא'.",
                punchline: "",
                category: "children"
            },
            {
                setup: "שני תפוחי אדמה צועדים בכביש. אחד מהם נדרס. מה אמר התפוח השני?",
                punchline: "אוי, פירה!",
                category: "puns"
            }
        ];
        
        // משתנים גלובליים
        let currentCategory = "all";
        let currentJokeIndex = -1;
        let jokeHistory = [];
        let favoriteJokes = [];
        let autoShowPunchline = false;
        let punchlineDelay = 3;
        let punchlineTimer = null;
        let isTranslated = false;
        let originalJoke = null;
        
        // הגדרות אפליקציה
        const appSettings = {
            darkMode: false,
            autoPunchline: false,
            punchlineDelay: 3,
            saveHistory: true,
            fontSize: "medium"
        };
        
        // טעינת הגדרות
        function loadSettings() {
            const savedSettings = localStorage.getItem('jokeGeneratorSettings');
            if (savedSettings) {
                const parsedSettings = JSON.parse(savedSettings);
                Object.assign(appSettings, parsedSettings);
                
                // החלת הגדרות
                if (appSettings.darkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('dark-mode-switch').checked = true;
                }
                
                autoShowPunchline = appSettings.autoPunchline;
                document.getElementById('auto-punchline-switch').checked = autoShowPunchline;
                
                punchlineDelay = appSettings.punchlineDelay;
                document.getElementById('punchline-delay').value = punchlineDelay;
                document.getElementById('delay-value').textContent = punchlineDelay;
                
                document.getElementById('save-history-switch').checked = appSettings.saveHistory;
                
                document.getElementById('font-size-select').value = appSettings.fontSize;
                applyFontSize(appSettings.fontSize);
            }
        }
        
        // שמירת הגדרות
        function saveSettings() {
            localStorage.setItem
			localStorage.setItem('jokeGeneratorSettings', JSON.stringify(appSettings));
            alert('ההגדרות נשמרו בהצלחה!');
        }
        
        // החלת גודל הגופן
        function applyFontSize(size) {
            const jokeElement = document.querySelector('.joke');
            const punchlineElement = document.querySelector('.punchline');
            
            switch(size) {
                case 'small':
                    jokeElement.style.fontSize = '18px';
                    punchlineElement.style.fontSize = '16px';
                    break;
                case 'medium':
                    jokeElement.style.fontSize = '24px';
                    punchlineElement.style.fontSize = '20px';
                    break;
                case 'large':
                    jokeElement.style.fontSize = '32px';
                    punchlineElement.style.fontSize = '28px';
                    break;
            }
        }
        
        // איפוס הגדרות
        function resetSettings() {
            appSettings.darkMode = false;
            appSettings.autoPunchline = false;
            appSettings.punchlineDelay = 3;
            appSettings.saveHistory = true;
            appSettings.fontSize = "medium";
            
            document.body.classList.remove('dark-mode');
            document.getElementById('dark-mode-switch').checked = false;
            document.getElementById('auto-punchline-switch').checked = false;
            document.getElementById('punchline-delay').value = 3;
            document.getElementById('delay-value').textContent = '3';
            document.getElementById('save-history-switch').checked = true;
            document.getElementById('font-size-select').value = "medium";
            
            applyFontSize("medium");
            saveSettings();
        }
        
        // טעינת בדיחות מקומיות
        function loadJokes() {
            const savedJokes = localStorage.getItem('jokes');
            if (savedJokes) {
                jokes = JSON.parse(savedJokes);
            }
            updateJokeCount();
            displayJokesInAdmin();
        }
        
        // שמירת בדיחות
        function saveJokes() {
            localStorage.setItem('jokes', JSON.stringify(jokes));
            updateJokeCount();
        }
        
        // עדכון מספר הבדיחות
        function updateJokeCount() {
            document.getElementById('joke-count').textContent = jokes.length;
        }
        
        // טעינת היסטוריה
        function loadHistory() {
            const savedHistory = localStorage.getItem('jokeHistory');
            if (savedHistory) {
                jokeHistory = JSON.parse(savedHistory);
                updateHistoryDisplay();
            }
            
            const savedFavorites = localStorage.getItem('favoriteJokes');
            if (savedFavorites) {
                favoriteJokes = JSON.parse(savedFavorites);
                updateFavoritesDisplay();
            }
        }
        
        // שמירת היסטוריה
        function saveHistory() {
            if (appSettings.saveHistory) {
                localStorage.setItem('jokeHistory', JSON.stringify(jokeHistory));
            }
        }
        
        // שמירת מועדפים
        function saveFavorites() {
            localStorage.setItem('favoriteJokes', JSON.stringify(favoriteJokes));
        }
        
        // סינון בדיחות לפי קטגוריה
        function getJokesByCategory(category) {
            if (category === 'all') {
                return jokes;
            } else {
                return jokes.filter(joke => joke.category === category);
            }
        }
        
        // בחירת בדיחה אקראית
        function getRandomJoke() {
            const filteredJokes = getJokesByCategory(currentCategory);
            if (filteredJokes.length === 0) {
                return {
                    setup: "אין בדיחות בקטגוריה זו.",
                    punchline: "נסה להוסיף בדיחה או לבחור קטגוריה אחרת.",
                    category: currentCategory
                };
            }
            
            let newIndex;
            // וודא שלא נראה את אותה בדיחה פעמיים ברצף
            do {
                newIndex = Math.floor(Math.random() * filteredJokes.length);
            } while (newIndex === currentJokeIndex && filteredJokes.length > 1);
            
            currentJokeIndex = newIndex;
            return filteredJokes[currentJokeIndex];
        }
        
        // הצגת בדיחה חדשה
        function displayNewJoke() {
            resetUI();
            
            const joke = getRandomJoke();
            originalJoke = joke;
            isTranslated = false;
            
            document.querySelector('.joke').textContent = joke.setup;
            document.querySelector('.punchline').textContent = joke.punchline;
            document.getElementById('current-category').textContent = getCategoryName(joke.category);
            
            const filteredJokes = getJokesByCategory(currentCategory);
            document.getElementById('joke-counter').textContent = `${currentJokeIndex + 1}/${filteredJokes.length}`;
            
            // אפשור כפתורים
            document.getElementById('show-punchline-btn').disabled = joke.punchline.length === 0;
            document.getElementById('translate-joke-btn').disabled = false;
            document.getElementById('download-joke-btn').disabled = false;
            document.getElementById('favorite-joke-btn').disabled = false;
            
            // בדיקה אם זו בדיחה מועדפת
            updateFavoriteButtonUI();
            
            // איפוס דירוג
            resetRating();
            
            // הצגת דירוג ממוצע אם קיים
            displayAverageRating(joke);
            
            // הוספה להיסטוריה
            if (appSettings.saveHistory) {
                addToHistory(joke);
            }
            
            // הצגת פואנטה אוטומטית
            if (autoShowPunchline && joke.punchline.length > 0) {
                clearTimeout(punchlineTimer);
                showProgressBar();
                punchlineTimer = setTimeout(() => {
                    showPunchline();
                }, punchlineDelay * 1000);
            }
        }
        
        // איפוס ממשק בדיחה
        function resetUI() {
            document.querySelector('.punchline').classList.remove('show');
            document.querySelector('.progress-container').style.display = 'none';
            clearTimeout(punchlineTimer);
        }
        
        // הצגת שם קטגוריה
        function getCategoryName(category) {
            const categoryNames = {
                'short': 'קצרות',
                'programmer': 'מתכנתים',
                'dad': 'אבא',
                'long': 'ארוכות',
                'children': 'ילדים',
                'animals': 'חיות',
                'workplace': 'עבודה',
                'puns': 'משחקי מילים',
                'custom': 'מותאמות אישית',
                'all': 'הכל'
            };
            
            return categoryNames[category] || category;
        }
        
        // הצגת פואנטה
        function showPunchline() {
            document.querySelector('.punchline').classList.add('show');
            document.querySelector('.progress-container').style.display = 'none';
        }
        
        // הצגת סרגל התקדמות
        function showProgressBar() {
            const progressContainer = document.querySelector('.progress-container');
            const progressBar = document.querySelector('.progress-bar');
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            
            let width = 0;
            const interval = setInterval(() => {
                if (width >= 100) {
                    clearInterval(interval);
                } else {
                    width += (100 / (punchlineDelay * 10));
                    progressBar.style.width = width + '%';
                }
            }, 100);
        }
        
        // הוספה להיסטוריה
        function addToHistory(joke) {
            // בדיקה אם כבר קיימת בהיסטוריה
            const existingIndex = jokeHistory.findIndex(j => j.setup === joke.setup);
            if (existingIndex !== -1) {
                jokeHistory.splice(existingIndex, 1);
            }
            
            // הוספה לתחילת המערך
            jokeHistory.unshift({
                setup: joke.setup,
                punchline: joke.punchline,
                category: joke.category,
                timestamp: new Date().toISOString()
            });
            
            // הגבלת הגודל ל-20 בדיחות
            if (jokeHistory.length > 20) {
                jokeHistory.pop();
            }
            
            saveHistory();
            updateHistoryDisplay();
        }
        
        // עדכון תצוגת היסטוריה
        function updateHistoryDisplay() {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (jokeHistory.length === 0) {
                historyList.innerHTML = '<p>אין היסטוריית בדיחות.</p>';
                return;
            }
            
            jokeHistory.forEach((joke, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = new Date(joke.timestamp);
                const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`;
                
                historyItem.innerHTML = `
                    <div>${joke.setup}</div>
                    <div class="joke-info">
                        <small>${getCategoryName(joke.category)} | ${formattedDate}</small>
                    </div>
                `;
                
                historyItem.addEventListener('click', () => {
                    showJokeFromHistory(index);
                });
                
                historyList.appendChild(historyItem);
            });
        }
        
        // הצגת בדיחה מההיסטוריה
        function showJokeFromHistory(index) {
            const joke = jokeHistory[index];
            originalJoke = joke;
            isTranslated = false;
            
            document.querySelector('.joke').textContent = joke.setup;
            document.querySelector('.punchline').textContent = joke.punchline;
            document.getElementById('current-category').textContent = getCategoryName(joke.category);
            
            document.querySelector('.punchline').classList.add('show');
            document.getElementById('show-punchline-btn').disabled = true;
            document.getElementById('translate-joke-btn').disabled = false;
            document.getElementById('download-joke-btn').disabled = false;
            document.getElementById('favorite-joke-btn').disabled = false;
            
            document.querySelector('.joke-history').style.display = 'none';
            
            updateFavoriteButtonUI();
            resetRating();
            displayAverageRating(joke);
        }
        
        // עדכון תצוגת מועדפים
        function updateFavoritesDisplay() {
            const favoritesList = document.getElementById('favorites-list');
            favoritesList.innerHTML = '';
            
            if (favoriteJokes.length === 0) {
                favoritesList.innerHTML = '<p>אין בדיחות מועדפות.</p>';
                return;
            }
            
            favoriteJokes.forEach((joke, index) => {
                const favoriteItem = document.createElement('div');
                favoriteItem.className = 'history-item';
                
                favoriteItem.innerHTML = `
                    <div>${joke.setup}</div>
                    <div class="joke-info">
                        <small>${getCategoryName(joke.category)}</small>
                        <button class="icon-button remove-favorite" data-index="${index}">❌</button>
                    </div>
                `;
                
                favoriteItem.querySelector('.history-item').addEventListener('click', () => {
                    showJokeFromFavorites(index);
                });
                
                favoriteItem.querySelector('.remove-favorite').addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeFavorite(index);
                });
                
                favoritesList.appendChild(favoriteItem);
            });
        }
        
        // הצגת בדיחה מהמועדפים
        function showJokeFromFavorites(index) {
            const joke = favoriteJokes[index];
            originalJoke = joke;
            isTranslated = false;
            
            document.querySelector('.joke').textContent = joke.setup;
            document.querySelector('.punchline').textContent = joke.punchline;
            document.getElementById('current-category').textContent = getCategoryName(joke.category);
            
            document.querySelector('.punchline').classList.add('show');
            document.getElementById('show-punchline-btn').disabled = true;
            document.getElementById('translate-joke-btn').disabled = false;
            document.getElementById('download-joke-btn').disabled = false;
            document.getElementById('favorite-joke-btn').disabled = false;
            
            document.querySelector('.favorites-container').style.display = 'none';
            
            updateFavoriteButtonUI();
            resetRating();
            displayAverageRating(joke);
        }
        
        // הוספה למועדפים
        function toggleFavorite() {
            const currentJoke = isTranslated ? originalJoke : {
                setup: document.querySelector('.joke').textContent,
                punchline: document.querySelector('.punchline').textContent,
                category: originalJoke.category
            };
            
            const existingIndex = favoriteJokes.findIndex(j => j.setup === currentJoke.setup);
            
            if (existingIndex !== -1) {
                // הסרה מהמועדפים
                favoriteJokes.splice(existingIndex, 1);
                document.getElementById('favorite-joke-btn').textContent = '❤️ מועדף';
            } else {
                // הוספה למועדפים
                favoriteJokes.push(currentJoke);
                document.getElementById('favorite-joke-btn').textContent = '❌ הסר ממועדפים';
            }
            
            saveFavorites();
            updateFavoritesDisplay();
        }
        
        // הסרה מהמועדפים
        function removeFavorite(index) {
            favoriteJokes.splice(index, 1);
            saveFavorites();
            updateFavoritesDisplay();
            updateFavoriteButtonUI();
        }
        
        // עדכון כפתור מועדפים
        function updateFavoriteButtonUI() {
            const currentJoke = isTranslated ? originalJoke : {
                setup: document.querySelector('.joke').textContent,
                punchline: document.querySelector('.punchline').textContent
            };
            
            const isFavorite = favoriteJokes.some(j => j.setup === currentJoke.setup);
            
            if (isFavorite) {
                document.getElementById('favorite-joke-btn').textContent = '❌ הסר ממועדפים';
            } else {
                document.getElementById('favorite-joke-btn').textContent = '❤️ מועדף';
            }
        }
        
        // תרגום בדיחה
        async function translateJoke() {
            if (!originalJoke) return;
            
            if (isTranslated) {
                // חזרה לבדיחה המקורית
                document.querySelector('.joke').textContent = originalJoke.setup;
                document.querySelector('.punchline').textContent = originalJoke.punchline;
                document.getElementById('translate-joke-btn').textContent = 'תרגם לאנגלית';
                isTranslated = false;
            } else {
                // תרגום לאנגלית
                try {
                    const translateButton = document.getElementById('translate-joke-btn');
                    translateButton.disabled = true;
                    translateButton.textContent = 'מתרגם...';
                    
                    // כאן יש לבצע תרגום אמיתי באמצעות API
                    // אנחנו נשתמש בתרגום מדומה לדוגמה
                    setTimeout(() => {
                        const translatedSetup = `Translated: ${originalJoke.setup}`;
                        const translatedPunchline = `Translated: ${originalJoke.punchline}`;
                        
                        document.querySelector('.joke').textContent = translatedSetup;
                        document.querySelector('.punchline').textContent = translatedPunchline;
                        
                        translateButton.disabled = false;
                        translateButton.textContent = 'חזור לעברית';
                        isTranslated = true;
                    }, 1000);
                } catch (error) {
                    alert('שגיאה בתרגום: ' + error.message);
                }
            }
        }
        
        // דירוג בדיחה
        function rateJoke(rating) {
            if (!originalJoke) return;
            
            let jokesWithRatings = JSON.parse(localStorage.getItem('jokeRatings') || '[]');
            
            const existingIndex = jokesWithRatings.findIndex(j => j.setup === originalJoke.setup);
            
            if (existingIndex !== -1) {
                // עדכון דירוג קיים
                jokesWithRatings[existingIndex].ratings.push(rating);
            } else {
                // יצירת דירוג חדש
                jokesWithRatings.push({
                    setup: originalJoke.setup,
                    ratings: [rating]
                });
            }
            
            localStorage.setItem('jokeRatings', JSON.stringify(jokesWithRatings));
            
            // עדכון תצוגת דירוג
            updateRatingUI(rating);
            displayAverageRating(originalJoke);
        }
        
        // עדכון ממשק דירוג
        function updateRatingUI(rating) {
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach(star => {
                if (parseInt(star.dataset.rating) <= rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }
        
        // איפוס דירוג
        function resetRating() {
            const stars = document.querySelectorAll('.rating-star');
            stars.forEach(star => {
                star.classList.remove('active');
            });
            document.getElementById('avg-rating').textContent = '';
        }
        
        // הצגת דירוג ממוצע
        function displayAverageRating(joke) {
            const jokesWithRatings = JSON.parse(localStorage.getItem('jokeRatings') || '[]');
            const jokeRating = jokesWithRatings.find(j => j.setup === joke.setup);
            
            if (jokeRating && jokeRating.ratings.length > 0) {
                const avg = jokeRating.ratings.reduce((a, b) => a + b, 0) / jokeRating.ratings.length;
                document.getElementById('avg-rating').textContent = ` (${avg.toFixed(1)}/5)`;
            } else {
                document.getElementById('avg-rating').textContent = '';
            }
        }
        
        // שמירת בדיחה כתמונה
        function downloadJoke() {
            const jokeText = document.querySelector('.joke').textContent;
            const punchlineText = document.querySelector('.punchline').textContent;
            
            const canvas = document.getElementById('joke-canvas');
            const ctx = canvas.getContext('2d');
            
            // הגדרת גודל הקנבס
            canvas.width = 800;
            canvas.height = 600;
            
            // רקע
            ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#333' : '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // כותרת
            ctx.font = 'bold 32px Arial';
            ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#eee' : '#333';
            ctx.textAlign = 'center';
            ctx.fillText('מחולל הבדיחות', canvas.width / 2, 80);
            
            // טקסט הבדיחה
            ctx.font = '24px Arial';
            
            // פיצול טקסט ארוך לשורות
            const wrapText = (text, x, y, maxWidth, lineHeight) => {
                const words = text.split(' ');
                let line = '';
                let testLine = '';
                let lineArray = [];
                
                for (let i = 0; i < words.length; i++) {
                    testLine += words[i] + ' ';
                    const metrics = ctx.measureText(testLine);
                    if (metrics.width > maxWidth && i > 0) {
                        lineArray.push(line);
                        line = words[i] + ' ';
                        testLine = words[i] + ' ';
                    } else {
                        line = testLine;
                    }
                }
                
                lineArray.push(line);
                
                for (let i = 0; i < lineArray.length; i++) {
                    ctx.fillText(lineArray[i], x, y + (i * lineHeight));
                }
                
                return y + lineArray.length * lineHeight;
            };
            
            // כתיבת הבדיחה
            let y = 150;
            y = wrapText(jokeText, canvas.width / 2, y, 700, 30);
            
            // כתיבת הפואנטה אם יש
            if (punchlineText.length > 0) {
                ctx.font = 'bold 24px Arial';
                ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#66b0ff' : '#0077cc';
                y += 30;
                wrapText(punchlineText, canvas.width / 2, y, 700, 30);
            }
            
            // לוגו
            ctx.font = '16px Arial';
            ctx.fillStyle = document.body.classList.contains('dark-mode') ? '#aaa' : '#666';
            ctx.fillText('מחולל הבדיחות | נוצר על ידי Noam_v', canvas.width / 2, canvas.height - 30);
            
            // יצירת קישור להורדה
            const link = document.createElement('a');
            link.download = 'בדיחה.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
        
        // הוספת בדיחה חדשה
        function addNewJoke() {
            const setup = document.getElementById('new-joke-setup').value.trim();
            const punchline = document.getElementById('new-joke-punchline').value.trim();
            const category = document.getElementById('new-joke-category').value;
            
            if (setup === '') {
                alert('יש להזין טקסט בדיחה!');
                return;
            }
            
            const newJoke = {
                setup: setup,
                punchline: punchline,
                category: category
            };
            
            jokes.push(newJoke);
            saveJokes();
            
            alert('הבדיחה נוספה בהצלחה!');
            
            // ניקוי שדות הטופס
            document.getElementById('new-joke-setup').value = '';
            document.getElementById('new-joke-punchline').value = '';
            
            // עדכון רשימת הבדיחות בניהול
            displayJokesInAdmin();
        }
        
        // תצוגת בדיחות באזור הניהול
        function displayJokesInAdmin() {
            const jokesList = document.getElementById('jokes-list');
            jokesList.innerHTML = '';
            
            jokes.forEach((joke, index) => {
                const jokeItem = document.createElement('div');
                jokeItem.className = 'joke-item';
                jokeItem.innerHTML = `
                    <div><strong>בדיחה:</strong> ${joke.setup}</div>
                    <div><strong>פואנטה:</strong> ${joke.punchline}</div>
                    <div><strong>קטגוריה:</strong> ${getCategoryName(joke.category)}</div>
                    <div class="joke-item-controls">
                        <button onclick="editJoke(${index})">ערוך</button>
                        <button onclick="deleteJoke(${index})">מחק</button>
                    </div>
                `;
                jokesList.appendChild(jokeItem);
            });
        }
        
        // חיפוש בדיחות
        function searchJokes() {
            const searchTerm = document.getElementById('joke-search').value.toLowerCase();
            const jokesList = document.getElementById('jokes-list');
            jokesList.innerHTML = '';
            
            const filteredJokes = jokes.filter(joke => 
                joke.setup.toLowerCase().includes(searchTerm) || 
                joke.punchline.toLowerCase().includes(searchTerm)
            );
            
            if (filteredJokes.length === 0) {
                jokesList.innerHTML = '<p>לא נמצאו תוצאות.</p>';
                return;
            }
            
            filteredJokes.forEach((joke, index) => {
                const originalIndex = jokes.findIndex(j => j.setup === joke.setup && j.punchline === joke.punchline);
                
                const jokeItem = document.createElement('div');
                jokeItem.className = 'joke-item';
                jokeItem.innerHTML = `
                    <div><strong>בדיחה:</strong> ${joke.setup}</div>
                    <div><strong>פואנטה:</strong> ${joke.punchline}</div>
                    <div><strong>קטגוריה:</strong> ${getCategoryName(joke.category)}</div>
                    <div class="joke-item-controls">
                        <button onclick="editJoke(${originalIndex})">ערוך</button>
                        <button onclick="deleteJoke(${originalIndex})">מחק</button>
                    </div>
                `;
                jokesList.appendChild(jokeItem);
            });
        }
        
        // עריכת בדיחה
        function editJoke(index) {
            const joke = jokes[index];
            
            const newSetup = prompt('ערוך את הבדיחה:', joke.setup);
            if (newSetup === null) return;
            
            const newPunchline = prompt('ערוך את הפואנטה:', joke.punchline);
            if (newPunchline === null) return;
            
            joke.setup = newSetup;
            joke.punchline = newPunchline;
            
            saveJokes();
            displayJokesInAdmin();
            
            alert('הבדיחה עודכנה בהצלחה!');
        }
        
        // מחיקת בדיחה
        function deleteJoke(index) {
            if (confirm('האם אתה בטוח שברצונך למחוק בדיחה זו?')) {
                jokes.splice(index, 1);
                saveJokes();
                displayJokesInAdmin();
                alert('הבדיחה נמחקה בהצלחה!');
            }
        }
        
        // ייצוא בדיחות
        function exportJokes() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(jokes));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "jokes.json");
            document.body.appendChild(downloadAnchorNode); // required for firefox
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        
			// ייצוא בדיחות בפורמט CSV
			function exportJokesCSV() {
				let csvContent = "בדיחה,פואנטה,קטגוריה\n";
				
				jokes.forEach(joke => {
					csvContent += `"${joke.setup.replace(/"/g, '""')}","${joke.punchline.replace(/"/g, '""')}","${joke.category}"\n`;
				});
				
				const dataStr = "data:text/csv;charset=utf-8," + encodeURIComponent(csvContent);
				const downloadAnchorNode = document.createElement('a');
				downloadAnchorNode.setAttribute("href", dataStr);
				downloadAnchorNode.setAttribute("download", "jokes.csv");
				document.body.appendChild(downloadAnchorNode);
				downloadAnchorNode.click();
				downloadAnchorNode.remove();
			}
			
			// ייבוא בדיחות
			document.getElementById('import-jokes-file').addEventListener('change', function(e) {
				const file = e.target.files[0];
				if (!file) return;
				
				const reader = new FileReader();
				reader.onload = function(e) {
					try {
						const importedJokes = JSON.parse(e.target.result);
						
						if (Array.isArray(importedJokes)) {
							if (confirm(`נמצאו ${importedJokes.length} בדיחות. האם ברצונך להוסיף אותן?`)) {
								// מיזוג בדיחות ללא כפילויות
								const uniqueJokes = [];
								const existingSetups = jokes.map(j => j.setup);
								
								importedJokes.forEach(joke => {
									if (!existingSetups.includes(joke.setup)) {
										uniqueJokes.push(joke);
									}
								});
								
								jokes = [...jokes, ...uniqueJokes];
								saveJokes();
								displayJokesInAdmin();
								
								alert(`נוספו ${uniqueJokes.length} בדיחות חדשות.`);
							}
						} else {
							alert('הקובץ אינו במבנה תקין.');
						}
					} catch (